openapi: 3.0.3
info:
  title: Puntos Cybac - Client Mobile API
  version: 1.0.0
  description: >
    Contrato API enfocado en la app móvil del cliente (MVP).
    Incluye solo endpoints de cliente y autenticación por magic-link.
servers:
  - url: /api/v1
tags:
  - name: Client App
    description: Endpoints móviles para clientes.
security:
  - bearerAuth: []

paths:
  /auth/client/magic-links/consume:
    post:
      tags:
        - Client App
      summary: Consume magic-link y crea sesión persistente
      operationId: consumeClientMagicLink
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MagicLinkConsumeRequest'
            example:
              token: mlk_01JT7TQ3M2C8M4VQSKY9F1AJ9P
              device_name: flutter-android
      responses:
        '200':
          description: Token consumido y sesión cliente creada.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ClientSessionPayload'
              example:
                status: success
                message: Client session created.
                data:
                  access_token: <SECRET>
                  token_type: Bearer
                  profile:
                    client_identity:
                      id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                      full_name: Jane Client
                      email: jane.client@test.com
                      phone: '+5215550000000'
                      created_at: '2026-02-10T10:00:00Z'
                    memberships:
                      - membership:
                          id: ffffffff-ffff-4fff-8fff-ffffffffffff
                          company_id: aaaaaaaa-aaaa-4aaa-8aaa-aaaaaaaaaaaa
                          client_identity_id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                          status: ACTIVE
                          card_uid: CARD-0001
                          points_balance_cached: 480
                          created_at: '2026-02-14T12:00:00Z'
                        client_identity:
                          id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                          full_name: Jane Client
                          email: jane.client@test.com
                          phone: '+5215550000000'
                          created_at: '2026-02-10T10:00:00Z'
                  cards:
                    - membership_id: ffffffff-ffff-4fff-8fff-ffffffffffff
                      company_id: aaaaaaaa-aaaa-4aaa-8aaa-aaaaaaaaaaaa
                      company_name: Glow Clinic
                      card_uid: CARD-0001
                      status: ACTIVE
                      qr_payload: CARD-0001
                      points_balance: 480
                      branding:
                        logo_url: https://cdn.example.com/glow/logo.png
                        color_primary: '#0A2540'
                        color_secondary: '#5B7FFF'
                        color_accent: '#F9C846'
                meta:
                  timestamp: '2026-02-16T10:20:00Z'
                  path: api/v1/auth/client/magic-links/consume
                  version: v1
        '400':
          $ref: '#/components/responses/ClientInvalidMagicLinkToken'
        '409':
          $ref: '#/components/responses/ClientMagicLinkAlreadyConsumed'
        '410':
          $ref: '#/components/responses/ClientMagicLinkExpired'

  /client/me/profile:
    get:
      tags:
        - Client App
      summary: Perfil del cliente autenticado
      operationId: clientProfile
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Perfil del cliente y memberships.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        $ref: '#/components/schemas/ClientProfile'
              example:
                status: success
                message: Client profile fetched.
                data:
                  client_identity:
                    id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                    full_name: Jane Client
                    email: jane.client@test.com
                    phone: '+5215550000000'
                    created_at: '2026-02-10T10:00:00Z'
                  memberships:
                    - membership:
                        id: ffffffff-ffff-4fff-8fff-ffffffffffff
                        company_id: aaaaaaaa-aaaa-4aaa-8aaa-aaaaaaaaaaaa
                        client_identity_id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                        status: ACTIVE
                        card_uid: CARD-0001
                        points_balance_cached: 480
                        created_at: '2026-02-14T12:00:00Z'
                      client_identity:
                        id: eeeeeeee-eeee-4eee-8eee-eeeeeeeeeeee
                        full_name: Jane Client
                        email: jane.client@test.com
                        phone: '+5215550000000'
                        created_at: '2026-02-10T10:00:00Z'
                meta:
                  timestamp: '2026-02-16T10:22:00Z'
                  path: api/v1/client/me/profile
                  version: v1
        '401':
          $ref: '#/components/responses/ClientUnauthenticated'

  /client/me/cards:
    get:
      tags:
        - Client App
      summary: Lista de tarjetas del cliente por membership
      operationId: clientCards
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Tarjetas del cliente.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/ClientCard'
              example:
                status: success
                message: Client cards fetched.
                data:
                  - membership_id: ffffffff-ffff-4fff-8fff-ffffffffffff
                    company_id: aaaaaaaa-aaaa-4aaa-8aaa-aaaaaaaaaaaa
                    company_name: Glow Clinic
                    card_uid: CARD-0001
                    status: ACTIVE
                    qr_payload: CARD-0001
                    points_balance: 480
                    branding:
                      logo_url: https://cdn.example.com/glow/logo.png
                      color_primary: '#0A2540'
                      color_secondary: '#5B7FFF'
                      color_accent: '#F9C846'
                  - membership_id: 11111111-1111-4111-8111-111111111111
                    company_id: bbbbbbbb-bbbb-4bbb-8bbb-bbbbbbbbbbbb
                    company_name: Fuel Stop
                    card_uid: CARD-0342
                    status: ACTIVE
                    qr_payload: CARD-0342
                    points_balance: 90
                    branding:
                      logo_url: https://cdn.example.com/fuel/logo.png
                      color_primary: '#1A1A1A'
                      color_secondary: '#4ECDC4'
                      color_accent: '#FF6B35'
                meta:
                  timestamp: '2026-02-16T10:22:30Z'
                  path: api/v1/client/me/cards
                  version: v1
        '401':
          $ref: '#/components/responses/ClientUnauthenticated'

  /client/me/ledger:
    get:
      tags:
        - Client App
      summary: Historial ledger del cliente
      description: >
        Retorna movimientos append-only ordenados del más reciente al más antiguo.
        Si se envía `membership_id`, debe pertenecer al cliente autenticado.
      operationId: clientLedgerHistory
      security:
        - bearerAuth: []
      parameters:
        - $ref: '#/components/parameters/Page'
        - $ref: '#/components/parameters/PerPage'
        - $ref: '#/components/parameters/MembershipIdQuery'
      responses:
        '200':
          description: Movimientos del cliente.
          content:
            application/json:
              schema:
                allOf:
                  - $ref: '#/components/schemas/ApiResponse'
                  - type: object
                    properties:
                      data:
                        type: array
                        items:
                          $ref: '#/components/schemas/LedgerEntry'
                      meta:
                        allOf:
                          - $ref: '#/components/schemas/ApiMeta'
                          - type: object
                            properties:
                              pagination:
                                $ref: '#/components/schemas/PaginationMeta'
              examples:
                filteredMembership:
                  summary: Filtrado por membership_id
                  value:
                    status: success
                    message: Client ledger fetched.
                    data:
                      - id: 3b9f5d26-4b12-4a78-bd50-92c9ca611111
                        membership_id: ffffffff-ffff-4fff-8fff-ffffffffffff
                        actor_user_id: cccccccc-cccc-4ccc-8ccc-cccccccccccc
                        type: EARN
                        points_delta: 30
                        purchase_amount_mxn: 450
                        reward_id: null
                        note: Ticket #A-120
                        related_entry_id: null
                        created_at: '2026-02-16T09:30:00Z'
                    meta:
                      timestamp: '2026-02-16T10:23:00Z'
                      path: api/v1/client/me/ledger?membership_id=ffffffff-ffff-4fff-8fff-ffffffffffff&page=1&per_page=25
                      version: v1
                      pagination:
                        total: 2
                        count: 1
                        per_page: 25
                        current_page: 1
                        total_pages: 1
                combinedMemberships:
                  summary: Combinado sin filtro membership_id
                  value:
                    status: success
                    message: Client ledger fetched.
                    data:
                      - id: 3b9f5d26-4b12-4a78-bd50-92c9ca611111
                        membership_id: ffffffff-ffff-4fff-8fff-ffffffffffff
                        actor_user_id: cccccccc-cccc-4ccc-8ccc-cccccccccccc
                        type: EARN
                        points_delta: 30
                        purchase_amount_mxn: 450
                        reward_id: null
                        note: Ticket #A-120
                        related_entry_id: null
                        created_at: '2026-02-16T09:30:00Z'
                      - id: 32196ac2-244a-4487-b4be-4f2013333333
                        membership_id: 11111111-1111-4111-8111-111111111111
                        actor_user_id: cccccccc-cccc-4ccc-8ccc-cccccccccccc
                        type: EARN
                        points_delta: 15
                        purchase_amount_mxn: 220
                        reward_id: null
                        note: Ticket #B-905
                        related_entry_id: null
                        created_at: '2026-02-16T08:50:00Z'
                    meta:
                      timestamp: '2026-02-16T10:23:30Z'
                      path: api/v1/client/me/ledger?page=1&per_page=25
                      version: v1
                      pagination:
                        total: 14
                        count: 2
                        per_page: 25
                        current_page: 1
                        total_pages: 1
        '401':
          $ref: '#/components/responses/ClientUnauthenticated'
        '403':
          $ref: '#/components/responses/ClientMembershipForbidden'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: API Token

  parameters:
    Page:
      name: page
      in: query
      description: Número de página (base 1).
      required: false
      schema:
        type: integer
        minimum: 1
        default: 1
    PerPage:
      name: per_page
      in: query
      description: Tamaño de página.
      required: false
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 25
    MembershipIdQuery:
      name: membership_id
      in: query
      description: UUID de membership para filtrar historial.
      required: false
      schema:
        type: string
        format: uuid

  responses:
    ClientUnauthenticated:
      description: Token cliente faltante, inválido o expirado.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: CLIENT_UNAUTHENTICATED
              message: Client authentication is required.
              details:
                reason: missing_or_invalid_token

    ClientMembershipForbidden:
      description: Membership no pertenece al cliente autenticado.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: MEMBERSHIP_NOT_OWNED
              message: The selected membership does not belong to the authenticated client.
              details:
                membership_id: ffffffff-ffff-4fff-8fff-ffffffffffff

    ClientInvalidMagicLinkToken:
      description: Formato de token inválido.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: MAGIC_LINK_INVALID_FORMAT
              message: Magic-link token format is invalid.
              details:
                token: malformed

    ClientMagicLinkAlreadyConsumed:
      description: Token ya fue consumido.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: MAGIC_LINK_ALREADY_CONSUMED
              message: Magic-link token was already consumed.
              details:
                consumed_at: '2026-02-16T09:55:00Z'

    ClientMagicLinkExpired:
      description: Token expirado.
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorEnvelope'
          example:
            error:
              code: MAGIC_LINK_EXPIRED
              message: Magic-link token expired.
              details:
                expired_at: '2026-02-16T08:00:00Z'

  schemas:
    ApiResponse:
      type: object
      required:
        - status
        - message
        - meta
      properties:
        status:
          type: string
          example: success
        message:
          type: string
          example: Operation completed successfully.
        data:
          nullable: true
        meta:
          $ref: '#/components/schemas/ApiMeta'

    ApiMeta:
      type: object
      required:
        - timestamp
        - path
        - version
      properties:
        timestamp:
          type: string
          format: date-time
        path:
          type: string
          example: api/v1/client/me/profile
        version:
          type: string
          example: v1

    ErrorEnvelope:
      type: object
      required:
        - error
      properties:
        error:
          $ref: '#/components/schemas/ErrorBody'

    ErrorBody:
      type: object
      required:
        - code
        - message
      properties:
        code:
          type: string
          example: CLIENT_UNAUTHENTICATED
        message:
          type: string
          example: Client authentication is required.
        details:
          type: object
          additionalProperties: true

    MagicLinkConsumeRequest:
      type: object
      required:
        - token
      properties:
        token:
          type: string
          minLength: 10
          maxLength: 255
          example: mlk_01JT7TQ3M2C8M4VQSKY9F1AJ9P
        device_name:
          type: string
          maxLength: 120
          example: flutter-android

    ClientIdentity:
      type: object
      required:
        - id
        - full_name
      properties:
        id:
          type: string
          format: uuid
        full_name:
          type: string
        email:
          type: string
          format: email
          nullable: true
        phone:
          type: string
          nullable: true
        created_at:
          type: string
          format: date-time
          nullable: true

    ClientMembership:
      type: object
      required:
        - id
        - company_id
        - client_identity_id
        - status
        - card_uid
        - points_balance_cached
        - created_at
      properties:
        id:
          type: string
          format: uuid
        company_id:
          type: string
          format: uuid
        client_identity_id:
          type: string
          format: uuid
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
        card_uid:
          type: string
        points_balance_cached:
          type: integer
        created_at:
          type: string
          format: date-time

    ClientMembershipBundle:
      type: object
      required:
        - membership
        - client_identity
      properties:
        membership:
          $ref: '#/components/schemas/ClientMembership'
        client_identity:
          $ref: '#/components/schemas/ClientIdentity'

    ClientProfile:
      type: object
      required:
        - client_identity
        - memberships
      properties:
        client_identity:
          $ref: '#/components/schemas/ClientIdentity'
        memberships:
          type: array
          items:
            $ref: '#/components/schemas/ClientMembershipBundle'

    ClientBranding:
      type: object
      properties:
        logo_url:
          type: string
          format: uri
          nullable: true
        color_primary:
          type: string
          nullable: true
        color_secondary:
          type: string
          nullable: true
        color_accent:
          type: string
          nullable: true

    ClientCard:
      type: object
      required:
        - membership_id
        - company_id
        - company_name
        - card_uid
        - status
        - qr_payload
        - points_balance
        - branding
      properties:
        membership_id:
          type: string
          format: uuid
        company_id:
          type: string
          format: uuid
        company_name:
          type: string
        card_uid:
          type: string
        status:
          type: string
          enum:
            - ACTIVE
            - INACTIVE
        qr_payload:
          type: string
        points_balance:
          type: integer
        branding:
          $ref: '#/components/schemas/ClientBranding'

    ClientSessionPayload:
      type: object
      required:
        - access_token
        - token_type
        - profile
        - cards
      properties:
        access_token:
          type: string
        token_type:
          type: string
          example: Bearer
        profile:
          $ref: '#/components/schemas/ClientProfile'
        cards:
          type: array
          items:
            $ref: '#/components/schemas/ClientCard'

    LedgerEntry:
      type: object
      required:
        - id
        - membership_id
        - actor_user_id
        - type
        - points_delta
        - created_at
      properties:
        id:
          type: string
          format: uuid
        membership_id:
          type: string
          format: uuid
        actor_user_id:
          type: string
          format: uuid
          nullable: true
        type:
          type: string
          enum:
            - EARN
            - REDEEM
            - ADJUST
            - REVERSE
        points_delta:
          type: integer
        purchase_amount_mxn:
          type: number
          format: float
          nullable: true
        reward_id:
          type: string
          format: uuid
          nullable: true
        note:
          type: string
          nullable: true
        related_entry_id:
          type: string
          format: uuid
          nullable: true
        created_at:
          type: string
          format: date-time

    PaginationMeta:
      type: object
      required:
        - total
        - count
        - per_page
        - current_page
        - total_pages
      properties:
        total:
          type: integer
        count:
          type: integer
        per_page:
          type: integer
        current_page:
          type: integer
        total_pages:
          type: integer
